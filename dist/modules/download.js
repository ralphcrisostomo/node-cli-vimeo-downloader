"use strict";var Download,ProgressBar,_,async,chalk,fs,mixin,request;_=require("lodash"),async=require("async"),request=require("superagent"),ProgressBar=require("progress"),chalk=require("chalk"),fs=require("fs"),mixin=require("./mixin"),Download=function(){function n(){this.retry=0}return n.prototype.run=function(n){return function(e){return function(t){return async.waterfall([e._getId(n),e._getVimeoPage(),e._getRequestFiles(),e._downloadVideo(n),e._updateManifest(n)],function(r,i){return"retry"===r?(mixin.write("red","\n------------------"),mixin.write("red","\nRetrying... ("+e.retry+")"),e.run(n)(t)):"continue"===r?e.run(n)(t):t(r,i)})}}(this)},n.prototype._getId=function(n){return function(e){var t,r,i,u;return i=process.cwd()+"/"+n+"/manifest.json",u=require(i),t=_.filter(u,{status:"completed"}),r=_.find(u,{status:"created"}),_.isEmpty(r)?(mixin.write("green","\nDownload Complete"),e("completed",null)):(mixin.write("cyan","\n------------------"),mixin.write("cyan","\nIndex 		: "+((null!=t?t.length:void 0)+1)+" of "+(null!=u?u.length:void 0)),mixin.write("cyan","\nId 		: "+(null!=r?r.id:void 0)),mixin.write("cyan","\nName 		: "+(null!=r?r.name:void 0)),e(null,null!=r?r.id:void 0))}},n.prototype._getVimeoPage=function(){return function(n){return function(e,t){var r;return r=e,request.get("https://player.vimeo.com/video/"+r).end(function(e,r){return e?(n.retry++,mixin.write("cyan","\nStatus 		: Failed"),t("retry",null)):(n.retry=0,t(null,null!=r?r.text:void 0))})}}(this)},n.prototype._getRequestFiles=function(){return function(n,e){var t,r,i,u,o,l;return t=n,u=/t={(.*)};if/,o=/{(.*)}/,l=null!=t?t.match(u):void 0,l=null!=l&&null!=(i=l[0])?i.match(o):void 0,r=JSON.parse(null!=l?l[0]:void 0),e(null,r)}},n.prototype._downloadVideo=function(n){return function(e,t){var r,i,u,o,l,a,s;return i=e,r=null!=i&&null!=(u=i.request)?u.files:void 0,s=null!=i?i.video:void 0,a=null!=r&&null!=(o=r.h264)&&null!=(l=o.hd)?l.url:void 0,mixin.write("cyan","\nUrl 		: "+a),request.get(a).parse(function(e){return function(e){var r,i,u;return i=fs.createWriteStream(process.cwd()+"/"+n+"/_"+s.title+" ["+s.id+"].mp4"),u={complete:"=",incomplete:" ",width:20,total:parseInt(e.headers["content-length"],10)},r=new ProgressBar("Downloading 	: [:bar] :percent :etas",u),e.on("data",function(n){return r.tick(n.length)}),e.on("end",function(){return mixin.write("green","Downloaded 	: "+s.title+" ["+s.id+"].mp4"),t(null,s)}),e.pipe(i)}}(this)).end(function(n,e){})}},n.prototype._updateManifest=function(n){return function(e,t){var r,i,u,o,l;return l=e,r=[],u=process.cwd()+"/"+n+"/manifest.json",o=require(u),null!=o&&o.forEach(function(n){return parseInt(null!=n?n.id:void 0)===parseInt(null!=l?l.id:void 0)&&(n.status="completed"),r.push(n)}),i=_.filter(r,{status:"completed"}),fs.writeFile(u,JSON.stringify(r,null,4),function(n){return function(n){return i.length<=r.length?t("continue",l):t(null,l)}}(this))}},n}(),module.exports=Download;