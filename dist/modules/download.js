"use strict";var Download,ProgressBar,_,async,chalk,fs,mixin,request;_=require("lodash"),async=require("async"),request=require("superagent"),ProgressBar=require("progress"),chalk=require("chalk"),fs=require("fs"),mixin=require("./mixin"),Download=function(){function e(){this.retry=0}return e.prototype.run=function(e){return function(n){return function(t){return async.waterfall([n._getId(e),n._getVimeoPage(),n._getRequestFiles(),n._downloadVideo(e),n._updateManifest(e)],function(r,i){return"retry"===r?(mixin.write("red","\n------------------"),mixin.write("red","\nRetrying... ("+n.retry+")"),n.run(e)(t)):"continue"===r?n.run(e)(t):t(r,i)})}}(this)},e.prototype._getId=function(e){return function(n){var t,r,i,u;return i=process.cwd()+"/"+e+"/manifest.json",u=require(i),t=_.filter(u,{status:"completed"}),r=_.find(u,{status:"created"}),_.isEmpty(r)?(mixin.write("green","\nDownload Complete"),n("completed",null)):(mixin.write("cyan","\n------------------"),mixin.write("cyan","\nIndex 		: "+((null!=t?t.length:void 0)+1)+" of "+(null!=u?u.length:void 0)),mixin.write("cyan","\nId 		: "+(null!=r?r.id:void 0)),mixin.write("cyan","\nName 		: "+(null!=r?r.name:void 0)),n(null,null!=r?r.id:void 0))}},e.prototype._getVimeoPage=function(){return function(e){return function(n,t){var r;return r=n,request.get("https://player.vimeo.com/video/"+r).end(function(n,r){return n?(e.retry++,mixin.write("cyan","\nStatus 		: Failed"),t("retry",null)):(e.retry=0,t(null,null!=r?r.text:void 0))})}}(this)},e.prototype._getRequestFiles=function(){return function(e,n){var t,r,i,u,o,l;return t=e,u=/t={(.*)};if/,o=/{(.*)}/,l=null!=t?t.match(u):void 0,l=null!=l&&null!=(i=l[0])?i.match(o):void 0,r=JSON.parse(null!=l?l[0]:void 0),n(null,r)}},e.prototype._downloadVideo=function(e){return function(n,t){var r,i,u,o,l,s,a;return i=n,r=null!=i&&null!=(u=i.request)?u.files:void 0,a=null!=i?i.video:void 0,s=null!=r&&null!=(o=r.h264)&&null!=(l=o.hd)?l.url:void 0,s="http://techslides.com/demos/sample-videos/small.mp4",mixin.write("cyan","\nUrl 		: "+s),request.get(s).parse(function(n){return function(n){var r,i,u;return i=fs.createWriteStream(process.cwd()+"/"+e+"/_"+a.title+" ["+a.id+"].mp4"),u={complete:"=",incomplete:" ",width:20,total:parseInt(n.headers["content-length"],10)},r=new ProgressBar("Downloading 	: [:bar] :percent :etas",u),n.on("data",function(e){return r.tick(e.length)}),n.on("end",function(){return mixin.write("green","Downloaded 	: "+a.title+" ["+a.id+"].mp4"),t(null,a)}),n.pipe(i)}}(this)).end(function(e,n){})}},e.prototype._updateManifest=function(e){return function(n,t){var r,i,u,o,l;return l=n,r=[],u=process.cwd()+"/"+e+"/manifest.json",o=require(u),null!=o&&o.forEach(function(e){return parseInt(null!=e?e.id:void 0)===parseInt(null!=l?l.id:void 0)&&(e.status="completed"),r.push(e)}),i=_.filter(r,{status:"completed"}),fs.writeFile(u,JSON.stringify(r,null,4),function(e){return function(e){return i.length<=r.length?t("continue",l):t(null,l)}}(this))}},e}(),module.exports=Download;